# SSL Certificate Troubleshooting Quick Reference

## ðŸš¨ Quick Diagnostics

### 1. Check if nginx is running
```bash
docker ps | grep nginx
```

### 2. Check nginx logs
```bash
docker logs nginx --tail 100
```

### 3. Check certificate files exist
```bash
ls -lh /opt/ssl/7gram.xyz/
```
**Expected**: Two files, fullchain.pem (~2-3KB) and privkey.pem (~1.7KB)
**Bad sign**: privkey.pem is 241 bytes or less = CORRUPTED

### 4. Verify certificates match
```bash
CERT_MOD=$(openssl x509 -noout -modulus -in /opt/ssl/7gram.xyz/fullchain.pem | openssl md5)
KEY_MOD=$(openssl rsa -noout -modulus -in /opt/ssl/7gram.xyz/privkey.pem | openssl md5)
echo "Cert: $CERT_MOD"
echo "Key:  $KEY_MOD"
```
**Good**: Both hashes are identical
**Bad**: Different hashes OR empty hash `d41d8cd98f00b204e9800998ecf8427e`

---

## ðŸ”§ Common Fixes

### Fix 1: Corrupted Certificates (MOST COMMON)
```bash
# Stop nginx
docker stop nginx

# Copy valid certs from Let's Encrypt
sudo mkdir -p /opt/ssl/7gram.xyz
sudo cp /etc/letsencrypt/live/7gram.xyz/fullchain.pem /opt/ssl/7gram.xyz/
sudo cp /etc/letsencrypt/live/7gram.xyz/privkey.pem /opt/ssl/7gram.xyz/
sudo chmod 644 /opt/ssl/7gram.xyz/fullchain.pem
sudo chmod 600 /opt/ssl/7gram.xyz/privkey.pem

# Restart nginx
cd ~/freddy && docker compose up -d nginx
```

### Fix 2: Use the Fix Script
```bash
cd ~/freddy
sudo ./scripts/fix-ssl-certs.sh
```

### Fix 3: Regenerate Certificates via CI/CD
1. Go to GitHub Actions
2. Run "ðŸ  Freddy Deploy" workflow
3. Check "force_ssl_regen"
4. Click "Run workflow"

---

## âŒ Error Messages & Solutions

### "Certificate and private key do not match"
**Cause**: Files are corrupted or from different sources
**Solution**: Run Fix 1 or Fix 2 above

### "Private key modulus: d41d8cd98f00b204e9800998ecf8427e"
**Cause**: Private key is empty (this is MD5 of empty string)
**Solution**: Run Fix 1 - copy from Let's Encrypt directory

### "Certificate verification failed"
**Cause**: Certificate is expired or invalid
**Solution**: Check expiry with:
```bash
openssl x509 -in /opt/ssl/7gram.xyz/fullchain.pem -noout -dates
```
If expired, regenerate with Fix 3

### "No such file or directory: /etc/letsencrypt-volume"
**Cause**: Volume mount in docker-compose is wrong
**Solution**: 
1. Check docker-compose.yml has: `/opt/ssl/7gram.xyz:/etc/letsencrypt-volume:ro`
2. Ensure `/opt/ssl/7gram.xyz` exists with certs

### "Permission denied" reading certificates
**Cause**: Wrong file permissions
**Solution**:
```bash
sudo chmod 644 /opt/ssl/7gram.xyz/fullchain.pem
sudo chmod 600 /opt/ssl/7gram.xyz/privkey.pem
```

---

## ðŸ” Deep Dive Checks

### Check certificate validity
```bash
openssl x509 -in /opt/ssl/7gram.xyz/fullchain.pem -noout -text
```

### Check certificate issuer
```bash
openssl x509 -in /opt/ssl/7gram.xyz/fullchain.pem -noout -issuer
```
**Good**: Contains "Let's Encrypt"
**Bad**: Contains your domain name (= self-signed)

### Check certificate expiry
```bash
openssl x509 -in /opt/ssl/7gram.xyz/fullchain.pem -noout -dates
```

### Check private key is valid
```bash
openssl rsa -in /opt/ssl/7gram.xyz/privkey.pem -check -noout
```
**Good**: "RSA key ok"
**Bad**: Any error = corrupted key

### Test HTTPS locally
```bash
curl -kI https://localhost/health
```

### Test HTTPS externally
```bash
curl -I https://7gram.xyz/health
```

---

## ðŸ“‹ Certificate Locations Cheat Sheet

| Location | Purpose | Notes |
|----------|---------|-------|
| `/etc/letsencrypt/live/7gram.xyz/` | Original Let's Encrypt certs | Generated by certbot |
| `/opt/ssl/7gram.xyz/` | Docker mount source | Used by docker-compose |
| `/etc/letsencrypt-volume/` | Inside nginx container | Mounted from `/opt/ssl/7gram.xyz/` |
| `/etc/nginx/ssl/` | Final location in container | Copied by entrypoint script |

---

## ðŸš€ Fresh Start (Nuclear Option)

If all else fails, clean everything and regenerate:

```bash
# Stop all services
cd ~/freddy
docker compose down

# Remove corrupted certificates
sudo rm -rf /opt/ssl/7gram.xyz
sudo mkdir -p /opt/ssl/7gram.xyz

# Copy from Let's Encrypt (if exists)
if [ -d /etc/letsencrypt/live/7gram.xyz ]; then
    sudo cp /etc/letsencrypt/live/7gram.xyz/fullchain.pem /opt/ssl/7gram.xyz/
    sudo cp /etc/letsencrypt/live/7gram.xyz/privkey.pem /opt/ssl/7gram.xyz/
    sudo chmod 644 /opt/ssl/7gram.xyz/fullchain.pem
    sudo chmod 600 /opt/ssl/7gram.xyz/privkey.pem
else
    echo "âŒ No Let's Encrypt certs found - trigger CI/CD to generate"
fi

# Remove Docker volumes (optional - forces fresh start)
docker volume rm ssl-certs 2>/dev/null || true

# Start services
docker compose up -d
```

---

## ðŸ“ž When to Ask for Help

Contact support/team if:
- [ ] All fixes above have been tried
- [ ] Certificate files don't exist in `/etc/letsencrypt/live/7gram.xyz/`
- [ ] Certbot is not installed or configured
- [ ] Cloudflare DNS is not working
- [ ] CI/CD pipeline is failing to generate certificates

Include this info in your request:
```bash
# System info
uname -a
docker --version
docker compose version

# Certificate status
ls -lR /etc/letsencrypt/live/
ls -lh /opt/ssl/7gram.xyz/

# Container status
docker ps -a | grep nginx
docker logs nginx --tail 50

# Test connectivity
curl -kI https://localhost/health
ping -c 3 7gram.xyz
```

---

## âœ… Success Indicators

You know it's working when:
- âœ… `docker ps` shows nginx as "healthy"
- âœ… `docker logs nginx` shows "âœ“ Let's Encrypt certificates configured"
- âœ… `curl -I https://7gram.xyz/health` returns 200 OK
- âœ… Browser shows valid certificate (green padlock)
- âœ… Certificate modulus matches key modulus

---

## ðŸ“š Related Documentation

- [SSL Certificate Fix Documentation](./SSL_CERTIFICATE_FIX.md) - Detailed explanation
- [Nginx Entrypoint Script](../docker/nginx/entrypoint.sh) - Certificate handling logic
- [CI/CD Workflow](../.github/workflows/ci-cd.yml) - Automated certificate generation